{% extends "base.html" %}
{% load static %}
{% block title %}{{ product.title }} - BoliBana {% endblock %}
{% load product_badges %}

{% block content %}
<div class="bg-white">
    <!-- Fil d'Ariane -->
    <div class="mx-auto max-w-2xl px-4 py-4 sm:px-6 lg:max-w-7xl lg:px-8">
        {% include "suppliers/components/breadcrumb.html" %}
    </div>

    <div class="mx-auto max-w-2xl px-4 py-8 sm:px-6 lg:max-w-7xl lg:px-8">
        <div class="lg:grid lg:grid-cols-2 lg:gap-x-8">
        <!-- Galerie d'images -->
            <div class="lg:max-w-lg lg:self-start">
            <div class="aspect-h-1 aspect-w-1 overflow-hidden rounded-lg bg-gray-100">
                    {% with display_image_url=product.get_display_image_url %}
                    {% if display_image_url %}
                        <img src="{{ display_image_url }}" 
                             alt="{{ product.title }}" 
                             class="h-full w-full object-contain object-center transition-transform duration-300 hover:scale-105"
                             loading="eager"
                             decoding="async">
                    {% elif images %}
                        <img src="{{ images.0.image.url }}" 
                             alt="{{ product.title }}" 
                             class="h-full w-full object-contain object-center transition-transform duration-300 hover:scale-105"
                             loading="eager"
                             decoding="async">
                    {% elif b2b_image_urls %}
                        <img src="{{ b2b_image_urls.0 }}" 
                             alt="{{ product.title }}" 
                             class="h-full w-full object-contain object-center transition-transform duration-300 hover:scale-105"
                             loading="eager"
                             decoding="async">
                    {% else %}
                        <img src="{% static 'images/no-image.svg' %}" 
                             alt="Image non disponible" 
                             class="h-full w-full object-contain object-center transition-transform duration-300 hover:scale-105"
                             loading="eager"
                             decoding="async">
                    {% endif %}
                    {% endwith %}
            </div>
            {% with display_image_url=product.get_display_image_url %}
            {% if display_image_url or images or b2b_image_urls %}
            <div class="mt-4 grid grid-cols-4 gap-4">
                {% if display_image_url %}
                <div class="aspect-h-1 aspect-w-1 overflow-hidden rounded-lg cursor-pointer hover:opacity-75 transition-all duration-300 bg-gray-50 ring-2 ring-new">
                        <img src="{{ display_image_url }}" 
                             alt="{{ product.title }}" 
                             class="h-full w-full object-cover object-center hover:scale-110 transition-transform duration-300"
                             loading="lazy"
                             decoding="async">
                </div>
                {% endif %}
                {% for image in images %}
                <div class="aspect-h-1 aspect-w-1 overflow-hidden rounded-lg cursor-pointer hover:opacity-75 transition-all duration-300 bg-gray-50">
                        <img src="{{ image.image.url }}" 
                             alt="{{ product.title }}" 
                             class="h-full w-full object-cover object-center hover:scale-110 transition-transform duration-300"
                             loading="lazy"
                             decoding="async">
                </div>
                {% endfor %}
                {% for url in b2b_image_urls %}
                    {% if display_image_url and display_image_url == url %}
                    {% else %}
                <div class="aspect-h-1 aspect-w-1 overflow-hidden rounded-lg cursor-pointer hover:opacity-75 transition-all duration-300 bg-gray-50">
                        <img src="{{ url }}" 
                             alt="{{ product.title }}" 
                             class="h-full w-full object-cover object-center hover:scale-110 transition-transform duration-300"
                             loading="lazy"
                             decoding="async">
                </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
        </div>

        <!-- Informations produit -->
            <div class="mt-8 lg:mt-0">
                <!-- Titre et badges -->
                <div class="flex flex-col space-y-4">
                    <div class="flex items-start justify-between">
                        <h1 class="text-2xl md:text-3xl font-bold font-bitter text-gray-900">{{ product.title }}</h1>
                        <div class="flex space-x-2">
                            {% product_badges product %}
                        </div>
                    </div>

                    <!-- Catégorie et SKU -->
                    <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                        {% if product.category %}
                        <span>Catégorie: <a href="{% url 'suppliers:category_detail' product.category.slug %}" class="text-new hover:underline">{{ product.category.name }}</a></span>
                        {% else %}
                        <span>Catégorie: <span class="text-gray-400">Sans catégorie</span></span>
                        {% endif %}
                        {% if product.sku %}
                            <span>Réf: {{ product.sku }}</span>
                        {% endif %}
                    </div>

            <!-- Prix -->
                    <div class="space-y-1">
                        {% if product.discount_price %}
                            <p class="text-gray-400 line-through text-sm">{{ product.format_price }}</p>
                            <p class="text-red-500 font-bold text-2xl">{{ product.format_discount_price }}</p>
                        {% else %}
                            <p class="text-gray-900 font-bold text-2xl">{{ product.format_price }}</p>
                {% endif %}
            </div>

                    <!-- Disponibilité -->
                    <div class="flex items-center text-sm {% if product.is_available %}text-new{% else %}text-red-500{% endif %}">
                        <svg class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        {% if product.is_available %}En stock{% else %}Rupture de stock{% endif %}
                    </div>

                    <!-- Boutons -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                        {% include "suppliers/components/_add_to_cart_button.html" with product=product is_detail=True %}
                        {% include "suppliers/components/_favorite_button.html" with product=product is_detail=True %}
                    </div>

                    <!-- Note moyenne -->
                    <div class="mt-8 border-t border-gray-200 pt-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="text-4xl font-bold text-gray-900">{{ average_rating|default:"0.0"|floatformat:1 }}</div>
                                <div class="flex items-center text-yellow-400">
                        {% for i in "12345" %}
                                        {% if forloop.counter <= average_rating|default:"0"|floatformat:"0"|add:"0" %}
                                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            {% else %}
                                            <svg class="h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                            {% endif %}
                        {% endfor %}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {% if review_count == 1 %}
                                        1 avis
                                    {% else %}
                                        {{ review_count|default:"0" }} avis
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

        <!-- Description et caractéristiques -->
        <div class="mt-12 lg:mt-16">
            <!-- Description -->
            <div class="mb-12">
                <h3 class="text-lg font-medium text-gray-900">Description</h3>
                <div class="mt-4 space-y-6 text-base text-gray-700">
                    {{ product.description|linebreaks }}
                </div>
            </div>

            <!-- Spécifications vêtement -->
            <div class="mt-8 border-t border-gray-200 pt-8">
                <h3 class="text-lg font-medium text-gray-900">Caractéristiques</h3>
                <div class="mt-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% if clothing.gender %}
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-500 transition-all duration-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">Genre</p>
                                    <p class="font-medium">{{ clothing.get_gender_display }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if clothing.material %}
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-500 transition-all duration-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">Matériau</p>
                                    <p class="font-medium">{{ clothing.material }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if clothing.style %}
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-500 transition-all duration-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">Style</p>
                                    <p class="font-medium">{{ clothing.style }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if clothing.season %}
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-500 transition-all duration-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                </svg>
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">Saison</p>
                                    <p class="font-medium">{{ clothing.season }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if clothing.size.all %}
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-500 transition-all duration-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                                </svg>
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">Tailles disponibles</p>
                                    <p class="font-medium">{{ clothing.size.all|join:", " }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if clothing.color.all %}
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-500 transition-all duration-300">
                            <div class="flex items-center gap-3">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                                </svg>
                                <div class="space-y-1">
                                    <p class="text-sm text-gray-600">Couleurs disponibles</p>
                                    <p class="font-medium">{{ clothing.color.all|join:", " }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% if clothing.care_instructions %}
            <!-- Instructions d'entretien -->
            <div class="mt-8 border-t border-gray-200 pt-8">
                <h3 class="text-lg font-medium text-gray-900">Instructions d'entretien</h3>
                <div class="mt-4 space-y-6 text-base text-gray-700">
                    {{ clothing.care_instructions|linebreaks }}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Avis -->
        <div class="mt-12 border-t border-gray-200 pt-12">
            {% include "suppliers/components/_reviews.html" %}
        </div>

        <!-- Produits similaires -->
        <div class="mt-12 border-t border-gray-200 pt-12">
            {% include "suppliers/components/_similar_products.html" with similar_products=similar_products category_slug=category_slug %}
        </div>
    </div>
</div>

<!-- Modal pour ajouter un avis -->
<div id="reviewModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white w-full max-w-lg mx-auto z-50">
                <!-- En-tête du modal -->
                <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-900">Ajouter un avis</h3>
                        <button type="button" onclick="closeReviewModal()" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-new focus:ring-offset-2">
                            <span class="sr-only">Fermer</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Contenu du formulaire -->
                <div class="px-4 sm:px-6 py-4 sm:py-6">
                    <form method="post" action="{% url 'suppliers:add_review' product.slug %}" class="space-y-4 sm:space-y-6">
                        {% csrf_token %}
                        <!-- Système de notation -->
                        <div>
                            <label class="block text-base font-medium text-gray-900 mb-3">Note</label>
                            <div class="flex items-center justify-center space-x-2 sm:space-x-3" id="rating-container">
                                {% for i in "12345" %}
                                <div class="relative">
                                    <input type="radio" id="rating-{{ i }}" name="rating" value="{{ i }}" class="peer sr-only" required>
                                    <label for="rating-{{ i }}" class="block cursor-pointer">
                                        <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-300 peer-checked:text-yellow-400 hover:text-yellow-400 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                        </svg>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Zone de commentaire -->
                        <div>
                            <label for="comment" class="block text-base font-medium text-gray-900 mb-2">Commentaire</label>
                            <textarea 
                                id="comment" 
                                name="comment" 
                                rows="4" 
                                required 
                                class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-new focus:ring-new text-base resize-none"
                                placeholder="Partagez votre expérience avec ce produit..."
                            ></textarea>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="flex flex-col gap-3 pt-4">
                            <button 
                                type="submit" 
                                class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-new via-new/90 to-new-dark hover:from-new-dark hover:via-new/90 hover:to-new focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-new transition-all duration-300"
                            >
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                Publier mon avis
                            </button>
                            <button 
                                type="button" 
                                onclick="closeReviewModal()" 
                                class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-new transition-all duration-300"
                            >
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                Annuler
                </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openReviewModal() {
        document.getElementById('reviewModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Gestion des étoiles
    document.addEventListener('DOMContentLoaded', function() {
        const ratingContainer = document.getElementById('rating-container');
        const ratingInputs = ratingContainer.querySelectorAll('input[type="radio"]');
        const ratingLabels = ratingContainer.querySelectorAll('label');

        // Fonction pour mettre à jour les étoiles
        function updateStars(index) {
            ratingLabels.forEach((label, i) => {
                const svg = label.querySelector('svg');
                if (i <= index) {
                    svg.classList.remove('text-gray-300');
                    svg.classList.add('text-yellow-400');
                } else {
                    svg.classList.remove('text-yellow-400');
                    svg.classList.add('text-gray-300');
                }
            });
        }

        // Gestion des événements pour chaque étoile
        ratingLabels.forEach((label, index) => {
            // Au survol
            label.addEventListener('mouseenter', () => {
                updateStars(index);
            });

            // Au clic
            label.addEventListener('click', () => {
                const input = label.previousElementSibling;
                input.checked = true;
                updateStars(index);
            });
        });

        // Au survol du conteneur
        ratingContainer.addEventListener('mouseleave', () => {
            const checkedInput = ratingContainer.querySelector('input[type="radio"]:checked');
            if (checkedInput) {
                const index = Array.from(ratingInputs).indexOf(checkedInput);
                updateStars(index);
            } else {
                updateStars(-1); // Réinitialiser toutes les étoiles
            }
        });
    });
</script>
{% endblock %} 