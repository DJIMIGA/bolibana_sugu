{% extends "base.html" %}
{% load static %}
{% load product_badges %}

{% block title %}{{ product.title }} - BoliBana{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<style>
    .swiper-button-next,
    .swiper-button-prev {
        color: #059669 !important; /* green-600 */
        background-color: white;
        width: 40px !important;
        height: 40px !important;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .swiper-button-next {
        right: -5px !important;
    }

    .swiper-button-prev {
        left: -5px !important;
    }

    .swiper-button-next:after,
    .swiper-button-prev:after {
        font-size: 20px !important;
    }

    .swiper-button-next:hover,
    .swiper-button-prev:hover {
        color: #047857 !important; /* green-700 */
        background-color: #f3f4f6;
    }

    .swiper-button-disabled {
        opacity: 0.35 !important;
        cursor: auto !important;
        pointer-events: none !important;
    }

    .swiper-pagination {
        position: relative !important;
        margin-top: 24px !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        gap: 8px !important;
    }

    .swiper-pagination-bullet {
        width: 8px !important;
        height: 8px !important;
        background: #E5E7EB !important; /* gray-200 */
        opacity: 1 !important;
        transition: all 0.3s ease !important;
        margin: 0 !important;
    }
    
    .swiper-pagination-bullet-active {
        background: #059669 !important; /* green-600 */
        transform: scale(1.2) !important;
        width: 10px !important;
        height: 10px !important;
    }
    
    .swiper-pagination-bullet:hover {
        background: #059669 !important; /* green-600 */
        opacity: 0.7 !important;
    }

    .swiper-slide {
        height: auto !important;
        display: flex !important;
        align-items: stretch !important;
    }

    .swiper-slide > * {
        width: 100% !important;
        height: 100% !important;
    }

    .swiper {
        padding: 0 5px !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Fil d'Ariane -->
  <div class="mb-8">
    {% include "suppliers/components/breadcrumb.html" with category=product.category product=product %}
    </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Galerie d'images -->
    <div class="space-y-4">
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        {% if images %}
        <img id="main-image" src="{{ images.0.image.url }}" alt="{{ product.title }}" class="w-full h-auto object-cover">
        {% elif product.image %}
        <img id="main-image" src="{{ product.image.url }}" alt="{{ product.title }}" class="w-full h-auto object-cover">
        {% else %}
        <img id="main-image" src="{% static 'images/no-image.svg' %}" alt="Image non disponible" class="w-full h-auto object-cover">
        {% endif %}
            </div>
            {% if images %}
      <div class="grid grid-cols-4 gap-2">
                {% for image in images %}
        <button onclick="changeMainImage('{{ image.image.url }}', this)" class="w-full h-24 rounded overflow-hidden focus:outline-none focus:ring-2 focus:ring-new">
          <img src="{{ image.image.url }}" alt="{{ product.title }}" class="w-full h-full object-cover">
        </button>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Informations produit -->
    <div class="space-y-6">
      <!-- Titre et badges -->
      <div class="flex items-start justify-between">
        <h1 class="text-2xl md:text-3xl font-bold font-bitter text-gray-900">{{ product.title }}</h1>
        <div class="flex space-x-2">
          {% product_badges product %}
        </div>
      </div>

      <!-- Catégorie et SKU -->
      <div class="flex items-center space-x-4 text-sm text-gray-500">
        <span>Catégorie: <a href="{% url 'suppliers:category_detail' product.category.slug %}" class="text-new hover:underline">{{ product.category.name }}</a></span>
        {% if product.sku %}
        <span>Réf: {{ product.sku }}</span>
        {% endif %}
      </div>

            <!-- Prix -->
      <div class="space-y-1">
        {% if product.discount_price %}
        <p class="text-gray-400 line-through text-sm">{{ product.format_price }}</p>
        <p class="text-red-500 font-bold text-2xl">{{ product.format_discount_price }}</p>
        {% else %}
        <p class="text-gray-900 font-bold text-2xl">{{ product.format_price }}</p>
        {% endif %}
      </div>

      <!-- Disponibilité -->
      <div class="flex items-center text-sm {% if product.is_available %}text-new{% else %}text-red-500{% endif %}">
        <svg class="h-5 w-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        {% if product.is_available %}En stock{% else %}Rupture de stock{% endif %}
      </div>

      <!-- Boutons -->
      <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
        <div class="space-y-4">
          <div>
            {% if product.discount_price %}
              <p class="text-lg text-gray-400 line-through">{{ product.format_price }}</p>
              <p class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-green-600 via-yellow-500 to-red-500 bg-clip-text text-transparent">
                {{ product.format_discount_price }}
              </p>
            {% else %}
              <p class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-green-600 via-yellow-500 to-red-500 bg-clip-text text-transparent">
                {{ product.format_price }}
              </p>
            {% endif %}
            <p class="text-sm text-gray-600">Prix TTC, livraison incluse</p>
          </div>
          
          <div class="mt-6 flex flex-col sm:grid sm:grid-cols-2 gap-4">
            {% include "suppliers/components/_add_to_cart_button.html" with product=product is_detail=True %}
            {% include "suppliers/components/_favorite_button.html" with product=product is_detail=True %}
          </div>
        </div>
      </div>

      <!-- Note moyenne -->
      <div class="mt-8 border-t border-gray-200 pt-6">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="text-4xl font-bold text-gray-900">{{ average_rating|floatformat:1 }}</div>
            <div class="flex items-center text-yellow-400">
              {% for i in "12345" %}
                {% if forloop.counter <= average_rating|floatformat:"0"|add:"0" %}
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                {% else %}
                <svg class="h-5 w-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                {% endif %}
              {% endfor %}
            </div>
            <div class="text-sm text-gray-500">
              {% if reviews.count == 1 %}
              1 avis
              {% else %}
              {{ reviews.count }} avis
              {% endif %}
            </div>
          </div>
        </div>
      </div>

            <!-- Description -->
      <div class="pt-6 border-t border-gray-200">
        <h2 class="text-lg font-medium text-gray-900 mb-2">Description</h2>
        <div class="prose prose-sm text-gray-600">
          {% if product.description %}
            {{ product.description|linebreaks|safe }}
          {% else %}
            <p class="text-gray-400 italic">Aucune description disponible pour ce produit.</p>
          {% endif %}
                </div>
            </div>

            <!-- Spécifications -->
            {% if product.specifications %}
      <div class="pt-4 border-t border-gray-200">
        <h2 class="text-lg font-medium text-gray-900 mb-2">Spécifications</h2>
        <ul class="list-disc pl-5 text-gray-600 space-y-1">
                        {% for key, value in product.specifications.items %}
          <li><span class="font-medium">{{ key }}:</span> {{ value }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Informations supplémentaires -->
      {% if product.weight or product.dimensions or product.condition or product.has_warranty or product.supplier or product.shipping_methods.exists or product.is_trending or product.sales_count or product.brand %}
      <div class="pt-4 border-t border-gray-200">
        <h2 class="text-lg font-medium text-gray-900 mb-2">Informations supplémentaires</h2>
        <dl class="grid grid-cols-1 gap-x-4 gap-y-2 sm:grid-cols-2">
          {% if product.brand %}
          <div class="sm:col-span-1">
            <dt class="text-sm font-medium text-gray-500">Marque</dt>
            <dd class="mt-1 text-sm text-gray-900">{{ product.brand }}</dd>
          </div>
          {% endif %}
          {% if product.weight %}
          <div class="sm:col-span-1">
            <dt class="text-sm font-medium text-gray-500">Poids</dt>
            <dd class="mt-1 text-sm text-gray-900">{{ product.weight }} kg</dd>
          </div>
          {% endif %}
          {% if product.dimensions %}
                        <div class="sm:col-span-1">
            <dt class="text-sm font-medium text-gray-500">Dimensions</dt>
            <dd class="mt-1 text-sm text-gray-900">{{ product.dimensions }}</dd>
                        </div>
          {% endif %}
          {% if product.condition %}
          <div class="sm:col-span-1">
            <dt class="text-sm font-medium text-gray-500">État</dt>
            <dd class="mt-1 text-sm text-gray-900">
              {% if product.condition == 'new' %}Neuf
              {% elif product.condition == 'used' %}Occasion
              {% elif product.condition == 'refurbished' %}Reconditionné
              {% endif %}
            </dd>
                </div>
          {% endif %}
          {% if product.has_warranty %}
          <div class="sm:col-span-1">
            <dt class="text-sm font-medium text-gray-500">Garantie</dt>
            <dd class="mt-1 text-sm text-gray-900">Incluse</dd>
            </div>
            {% endif %}

          {% if product.shipping_methods.exists %}
          <div class="sm:col-span-2">
            <dt class="text-sm font-medium text-gray-500">Méthodes de livraison</dt>
            <dd class="mt-1 text-sm text-gray-900">
              <ul class="list-disc pl-5">
                {% for method in product.shipping_methods.all %}
                <li>{{ method.name }} - {{ method.price|floatformat:0 }} FCFA ({{ method.get_delivery_time }})</li>
                {% endfor %}
              </ul>
            </dd>
          </div>
          {% endif %}
        </dl>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Avis -->
  {% include "suppliers/components/_reviews.html" %}

  <!-- Produits similaires -->
  {% include "suppliers/components/_similar_products.html" with similar_products=similar_products category_slug=category_slug %}

  <!-- Modal pour ajouter un avis -->
  <div id="reviewModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden z-50" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 z-50 overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white w-full max-w-lg mx-auto z-50">
          <!-- En-tête du modal -->
          <div class="px-4 sm:px-6 pt-4 sm:pt-6 pb-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-lg sm:text-xl font-semibold text-gray-900">Ajouter un avis</h3>
              <button type="button" onclick="closeReviewModal()" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-new focus:ring-offset-2">
                <span class="sr-only">Fermer</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Contenu du formulaire -->
          <div class="px-4 sm:px-6 py-4 sm:py-6">
            <form method="post" action="{% url 'suppliers:add_review' product.slug %}" class="space-y-4 sm:space-y-6">
              {% csrf_token %}
              <!-- Système de notation -->
              <div>
                <label class="block text-base font-medium text-gray-900 mb-3">Note</label>
                <div class="flex items-center justify-center space-x-2 sm:space-x-3" id="rating-container">
                  {% for i in "12345" %}
                  <div class="relative">
                    <input type="radio" id="rating-{{ i }}" name="rating" value="{{ i }}" class="peer sr-only" required>
                    <label for="rating-{{ i }}" class="block cursor-pointer">
                      <svg class="w-8 h-8 sm:w-10 sm:h-10 text-gray-300 peer-checked:text-yellow-400 hover:text-yellow-400 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>

              <!-- Zone de commentaire -->
              <div>
                <label for="comment" class="block text-base font-medium text-gray-900 mb-2">Commentaire</label>
                <textarea 
                  id="comment" 
                  name="comment" 
                  rows="4" 
                  required 
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-new focus:ring-new text-base resize-none"
                  placeholder="Partagez votre expérience avec ce produit..."
                ></textarea>
              </div>

              <!-- Boutons d'action -->
              <div class="flex flex-col gap-3 pt-4">
                <button 
                  type="submit" 
                  class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg text-white bg-gradient-to-r from-new via-new/90 to-new-dark hover:from-new-dark hover:via-new/90 hover:to-new focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-new transition-all duration-300"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Publier mon avis
                </button>
                <button 
                  type="button" 
                  onclick="closeReviewModal()" 
                  class="w-full inline-flex justify-center items-center px-4 py-2.5 border border-gray-200 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-new transition-all duration-300"
                >
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Annuler
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openReviewModal() {
      document.getElementById('reviewModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Gestion des étoiles
    document.addEventListener('DOMContentLoaded', function() {
      const ratingContainer = document.getElementById('rating-container');
      const ratingInputs = ratingContainer.querySelectorAll('input[type="radio"]');
      const ratingLabels = ratingContainer.querySelectorAll('label');

      // Fonction pour mettre à jour les étoiles
      function updateStars(index) {
        ratingLabels.forEach((label, i) => {
          const svg = label.querySelector('svg');
          if (i <= index) {
            svg.classList.remove('text-gray-300');
            svg.classList.add('text-yellow-400');
          } else {
            svg.classList.remove('text-yellow-400');
            svg.classList.add('text-gray-300');
          }
        });
      }

      // Gestion des événements pour chaque étoile
      ratingLabels.forEach((label, index) => {
        // Au survol
        label.addEventListener('mouseenter', () => {
          updateStars(index);
        });

        // Au clic
        label.addEventListener('click', () => {
          const input = label.previousElementSibling;
          input.checked = true;
          updateStars(index);
        });
      });

      // Au survol du conteneur
      ratingContainer.addEventListener('mouseleave', () => {
        const checkedInput = ratingContainer.querySelector('input[type="radio"]:checked');
        if (checkedInput) {
          const index = Array.from(ratingInputs).indexOf(checkedInput);
          updateStars(index);
        } else {
          updateStars(-1); // Réinitialiser toutes les étoiles
        }
      });
    });
  </script>
</div>

<!-- Script pour la galerie d'images -->
<script>
function changeMainImage(imageUrl, button) {
  // Mettre à jour l'image principale
  document.getElementById('main-image').src = imageUrl;
  
  // Mettre à jour l'état actif des boutons
  const buttons = document.querySelectorAll('[onclick^="changeMainImage"]');
  buttons.forEach(btn => {
    btn.classList.remove('ring-2', 'ring-new');
  });
  button.classList.add('ring-2', 'ring-new');
}
</script>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    new Swiper('.similarProductsSwiper', {
        slidesPerView: 1,
        spaceBetween: 24,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        breakpoints: {
            640: {
                slidesPerView: 2,
            },
            1024: {
                slidesPerView: 3,
            },
            1280: {
                slidesPerView: 4,
            },
        },
    });
});
</script>
{% endblock %} 